extends Node2D

const in_edit_mode: bool = false
var current_level_name = "RHYTHM_LING"

var fk_fall_time: float = 2.2
var fk_output_arr = [[], [], [], []]

var level_info = {
	"RHYTHM_LING" = {
		"fk_times": "[[0.00799994468689, 0.37066655158997, 0.78666667938232, 1.17066674232483, 6.74933319091797, 7.20799999237061, 7.64533309936523, 8.05066661834717, 13.6400001525879, 14.0560005187988, 14.4933326721191, 14.9093330383301, 16.4133327484131, 16.829333114624, 19.1120002746582, 20.807999420166, 22.4933326721191, 24.1999996185303, 25.9706657409668, 27.3573329925537, 29.3839996337891, 31.1120002746582, 32.7866676330566, 34.4933326721191, 36.189331817627, 49.6506660461426, 50.0773323059082, 50.4720008850098, 50.9093330383301, 53.6400001525879, 54.0773323059082, 56.76533203125, 58.5039985656738, 60.2213333129883, 61.9386642456055, 62.2373321533203, 65.3946655273437, 67.0693328857422, 68.7866638183594], [1.61866669654846, 2.04533319473267, 2.4933331489563, 2.88799982070923, 8.47733287811279, 8.89333324432373, 9.32000045776367, 9.7573335647583, 14.2906673431396, 14.6853340148926, 15.1120002746582, 15.6453330993652, 15.9973323822021, 16.1999996185303, 16.6586673736572, 17.3626659393311, 17.8960006713867, 18.333332824707, 19.6133335113525, 20.0506675720215, 21.3413341522217, 21.7680004119873, 23.0266674041748, 23.4853332519531, 24.7759998321533, 25.223999786377, 26.5040004730225, 26.9520004272461, 27.76266746521, 27.9973323822021, 28.2106674194336, 28.6266658782959, 29.9279983520508, 30.333332824707, 31.6133316040039, 32.0400016784668, 33.3306663513184, 35.0266654968262, 35.4746673583984, 36.776001739502, 37.2026679992676, 37.9386680603027, 38.4933326721191, 38.9199989318848, 39.6773345947266, 40.2106674194336, 40.7440002441406, 41.2026679992676, 42.3546684265137, 42.792000579834, 43.6240013122559, 44.4879997253418, 45.3200004577637, 46.1733329772949, 46.6746681213379, 47.0906684875488, 47.5173347473145, 47.9333351135254, 48.3706672668457, 48.7973335266113, 49.2453315734863, 50.6853340148926, 51.1440017700195, 51.6559989929199, 52.231999206543, 52.6266677856445, 54.3653343200684, 55.0693328857422, 55.6240013122559, 56.0400016784668, 57.341332244873, 57.7466667175293, 59.0266654968262, 59.4533317565918, 60.7440002441406, 61.1919982910156, 62.5466659545898, 62.8986633300781, 63.6986663818359, 64.2000015258789, 64.6373336791992, 65.8746688842773, 66.3226669311523, 67.6133316040039, 68.0293319702148, 69.3093307495117, 69.746662902832, 71.0480010986328, 71.5066650390625, 72.2853363037109, 72.7759979248047, 73.2026641845703, 73.9600036621094, 74.5146682739258, 74.9093368530273, 75.7093322753906, 76.2746704101562, 76.6373336791992], [5.04266672134399, 5.53333311080933, 5.95999984741211, 6.36533336639404, 11.9120004653931, 12.3600004196167, 12.7866666793823, 12.9893329620361, 13.1920001983643, 37.4053352355957, 37.6186683654785, 39.1120002746582, 39.3466651916504, 40.9893348693848, 70.4613311767578, 71.9119995117187, 73.4159973144531, 73.6506698608398, 75.1119964599609, 75.3573348999023], [3.31466655731201, 3.78400020599365, 4.17866687774658, 4.62666683197021, 10.1839998245239, 10.6426666259766, 11.0480001449585, 11.4960000991821, 15.3359992980957, 17.0213325500488, 17.6933334350586, 18.1306674957275, 18.5466659545898, 18.8026664733887, 19.3786666870117, 19.858666229248, 20.253332901001, 20.4879997253418, 21.1493328094482, 21.5546672821045, 21.9813335418701, 22.2160003662109, 22.8453338623047, 23.282666015625, 23.6986663818359, 23.9333332061768, 24.5946662902832, 25.0000007629395, 25.4053333282471, 25.6719997406006, 26.311999130249, 26.7173336029053, 27.1333339691162, 28.3919990539551, 28.8186672210693, 29.0853336334229, 29.6826675415039, 30.1093338012695, 30.5466659545898, 30.792000579834, 31.3999984741211, 31.826668548584, 32.2533348083496, 32.4879997253418, 33.0853317260742, 33.5226676940918, 33.9386680603027, 34.2053344726562, 34.8133323669434, 35.2506683349609, 35.6666648864746, 35.9119995117187, 36.5093315124512, 36.9679992675781, 38.258667755127, 38.6853340148926, 38.8986671447754, 39.9866683959961, 40.4026649475098, 51.3573348999023, 51.9866683959961, 52.3919990539551, 52.7866676330566, 53.0533340454102, 53.4160011291504, 53.8746650695801, 54.5360000610352, 54.7813346862793, 55.4213340759277, 55.8693321228027, 56.2426651000977, 56.4773338317871, 57.1066673278809, 57.5653350830078, 57.9279983520508, 58.1839988708496, 58.8026664733887, 59.2506683349609, 59.6773345947266, 59.9013336181641, 60.5306671142578, 60.9679992675781, 61.3946655273437, 61.6400001525879, 62.6853302001953, 63.1119964599609, 63.3573348999023, 63.9973342895508, 64.4133346557617, 65.0426681518555, 65.6933334350586, 66.1199996948242, 66.5466659545898, 66.749333190918, 67.3999984741211, 67.8373306274414, 68.2533309936523, 68.4880035400391, 69.0853317260742, 69.5653350830078, 69.9600036621094, 70.1840026855469, 70.8240020751953, 71.2933319091797, 71.6880004882812, 72.5733306884766, 73.0106704711914, 74.2586639404297, 74.7066696166992, 75.9866683959961, 76.4346664428711, 76.8826644897461]]",
		"music": load("res://music/Basshunter (8bit Version)_[cut_79sec].wav")
	}
}

func _ready():
	
	$MusicPlayer.stream = level_info.get(current_level_name).get("music")
	$MusicPlayer.play()
	
	if in_edit_mode:
		Signals.KeyListenerPress.connect(KeyListenerPress)
	else:
		var fk_times = level_info.get(current_level_name).get("fk_times")
		var fk_times_arr = str_to_var(fk_times)
		
		var counter: int = 0
		for key in fk_times_arr:
			
			var button_name: String = ""
			match counter:
				0:
					button_name = "button_Q"
				1:
					button_name = "button_W"
				2:
					button_name = "button_E"
				3:
					button_name = "button_R"
			
			for delay in key:
				SpawnFallingKey(button_name, delay)
			
			counter += 1

func KeyListenerPress(button_name: String, array_num: int):
	fk_output_arr[array_num].append($MusicPlayer.get_playback_position() - fk_fall_time)

func SpawnFallingKey(button_name: String, delay: float):
	await get_tree().create_timer(delay).timeout
	Signals.CreateFallingKey.emit(button_name)


func _on_music_player_finished():
	print(fk_output_arr)
	get_tree().change_scene_to_file("res://levels/win_condition.tscn")
