extends Node2D

const in_edit_mode: bool = false
var current_level_name = "RHYTHM_PUR"

var fk_fall_time: float = 2.2
var fk_output_arr = [[], [], [], []]

var level_info = {
	"RHYTHM_PUR" = {
		"fk_times": "[[2.02376394271851, 2.50374155044556, 2.93038539886475, 3.3996823310852, 8.80741481781006, 9.23405914306641, 9.71401386260986, 10.0980041503906, 15.5910423278809, 15.9963500976563, 16.4336727142334, 16.8603179931641, 29.1583221435547, 29.5636280059814, 29.958275604248, 30.4169166564941, 37.6165321350098, 38.0218589782715, 40.9976852416992, 41.4030158996582, 46.0747611999512, 46.5120628356934, 46.8747146606445, 47.3333557128906, 47.7493408203125, 48.1973007202148, 48.6452835083008, 48.9972770690918], [3.79433088302612, 4.19965963363647, 4.58362798690796, 4.99961452484131, 10.5353057861328, 10.9726303100586, 11.4312694549561, 11.825918006897, 17.276282119751, 17.702925491333, 18.1509063720703, 18.5988891601563, 25.7558277130127, 26.1931522369385, 27.4624031066895, 27.87839012146, 34.203377532959, 34.6513603210449, 35.078003692627, 35.504647064209, 38.3951690673828, 38.8431518554687, 41.7869842529297, 42.2563026428223, 49.4452369689941, 49.8932197570801, 50.3198631286621, 50.7145126342773, 51.1731536865234, 51.5891387939453, 52.0051010131836, 52.4104316711426, 54.5009735107422, 54.9596145629883, 55.3755996704102, 55.7809074401855, 56.2075508117676, 56.6235359191895, 57.0501831054687, 57.4768264770508], [7.12215404510498, 7.5701358795166, 8.00743751525879, 8.41276626586914, 14.3964393615723, 14.7804306030273, 15.1857364654541, 22.3746936798096, 22.833332824707, 23.2492969512939, 23.6439464569092, 24.0812690734863, 24.507914352417, 24.9132202148438, 25.3398635864258, 26.5984580993652, 27.0570972442627, 28.2836959838867, 28.7316787719727, 32.5181396484375, 32.9661224365234, 33.3821075439453, 33.8087547302246, 35.9526298522949, 36.3579376220703, 36.805916595459, 37.2005661010742, 40.1443984985352, 40.5390480041504, 42.7149436950684, 43.1415870666504, 43.5575492858887, 43.984196472168, 52.8263938903809, 53.285034942627, 53.6903617858887, 54.0956695556641, 57.9247863769531], [5.4369161605835, 5.85290222167969, 6.27954654693604, 6.7381856918335, 12.2098863601685, 12.6472108840942, 13.0738552093506, 13.4898183822632, 13.9591377258301, 18.9935367584229, 19.4095008850098, 19.8361442565918, 20.230793762207, 20.7001140594482, 21.1374156951904, 21.5534008026123, 21.980046081543, 30.832901763916, 31.259545135498, 31.6861923217773, 32.0808380126953, 39.2804534912109, 39.739094543457, 44.4001815795898, 44.837483215332, 45.2641265869141, 45.6374366760254]]",
		"music": load("res://music/Nyan Cat Short Version.wav")
	}
}

func _ready():
	
	$MusicPlayer.stream = level_info.get(current_level_name).get("music")
	$MusicPlayer.play()
	
	if in_edit_mode:
		Signals.KeyListenerPress.connect(KeyListenerPress)
	else:
		var fk_times = level_info.get(current_level_name).get("fk_times")
		var fk_times_arr = str_to_var(fk_times)
		
		var counter: int = 0
		for key in fk_times_arr:
			
			var button_name: String = ""
			match counter:
				0:
					button_name = "button_Q"
				1:
					button_name = "button_W"
				2:
					button_name = "button_E"
				3:
					button_name = "button_R"
			
			for delay in key:
				SpawnFallingKey(button_name, delay)
			
			counter += 1

func KeyListenerPress(button_name: String, array_num: int):
	fk_output_arr[array_num].append($MusicPlayer.get_playback_position() - fk_fall_time)

func SpawnFallingKey(button_name: String, delay: float):
	await get_tree().create_timer(delay).timeout
	Signals.CreateFallingKey.emit(button_name)


func _on_music_player_finished():
	print(fk_output_arr)
	get_tree().change_scene_to_file("res://levels/win_condition.tscn")
